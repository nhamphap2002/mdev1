var AmazonPayments=function(selectorFn,serializer){var _extendObj=function(e,r){for(var o in r)e[o]=r[o];return this},_xhrCall=function(e,r,o,t,n,a){var c=new XMLHttpRequest;c.onreadystatechange=function(){switch(c.readyState){case XMLHttpRequest.OPENED:n&&n();break;case XMLHttpRequest.DONE:200===c.status?o&&o(c.responseText):t&&t(c.statusText),a&&a()}},c.open("post",e,!0),c.setRequestHeader("Content-type","application/x-www-form-urlencoded"),c.send(r)},_getElementsBySelector=function(e){return selectorFn(e)},_getElementById=function(e){var r=_getElementsBySelector("#"+e);return r.length?r[0]:null},_getElementByName=function(e){var r=_getElementsBySelector(e);return r.length?r[0]:null},_evalJsScripts=function(html){for(var scripts=html.getElementsByTagName("script"),i=0;i<scripts.length;i++)eval(scripts[i].innerHTML)},_serializeForm=function(){var e=[];checkoutOrderReferenceId&&e.push("orderReferenceId="+checkoutOrderReferenceId);for(var r=0;r<arguments.length;r++){var o=_getElementById(arguments[r]);o&&e.push(serializer(o))}return e.join("&")},_setLoadWaiting=function(){for(var e=0;e<arguments.length;e++){var r=_getElementById(arguments[e]);if(r){var o=r.up("li");o&&o.addClassName("loading")}}},_unsetLoadWaiting=function(){for(var e=0;e<arguments.length;e++){var r=_getElementById(arguments[e]);if(r){var o=r.up("li");o&&o.removeClassName("loading")}}},_setFormLoadWaiting=function(){var e=_getElementById(config.pleaseWaitId);e&&e.show(),_showOverlay()},_unsetFormLoadWaiting=function(){var e=_getElementById(config.pleaseWaitId);e&&e.hide(),_hideOverlay()},_showOverlay=function(){var e=_getElementByName("body");e.insert('<div class="amazon-widget-overlay" id="'+config.amazonPleaseWaitOverlayId+'"></div>')},_hideOverlay=function(){var e=_getElementById(config.amazonPleaseWaitOverlayId);e&&e.remove()},config={live:!0,popup:!0,virtual:!1,pay:{selector:null,callbackUrl:null,design:null},login:{selector:null,callbackUrl:null,design:null},checkoutUrl:null,addToCartUrl:null,currency:null,debug:!1,scope:"profile payments:widget payments:shipping_address payments:billing_address",addToCartFormId:"product_addtocart_form",shippingMethodFormId:"co-shipping-method-form",discountCouponFormId:"discount-coupon-form",checkoutAgreementsFormId:"checkout-agreements",checkoutSubmitButtonId:"amazonpayments-checkout-place-order-button",simulationFormId:"sandbox-simulation",pleaseWaitId:"review-please-wait",amazonPleaseWaitOverlayId:"amazon-please-wait-overlay"},checkoutParams={responsive:!0,addressBook:"addressBookWidgetDiv",wallet:"walletWidgetDiv",shippingMethod:"shippingMethodWidgetDiv",review:"reviewWidgetDiv",urls:{}},checkoutOrderReferenceId=null,checkoutSubmitAllowed=!1,checkoutPaymentSelected=!1,addressBookWidget=null,walletWidget=null,errorCodes={clearOrderReference:["InvalidOrderReferenceId"],redirect:["BuyerNotAssociated","BuyerSessionExpired","StaleOrderReference"]},_addressSelectCallback=function(){_setCheckoutPaymentSelected(!1),_xhrCall(checkoutParams.urls.saveShipping,_serializeForm(),callbacks.onXhrSuccess,callbacks.onXhrError,function(){_setLoadWaiting(checkoutParams.shippingMethod,checkoutParams.review)},function(){_unsetLoadWaiting(checkoutParams.shippingMethod,checkoutParams.review)})},_orderReferenceCreateCallback=function(e){checkoutOrderReferenceId||(setOrderReferenceId(e.getAmazonOrderReferenceId()),config.virtual||_renderWalletWidget())},_paymentSelectCallback=function(){_setCheckoutPaymentSelected(!0)},_shippingMethodSelectCallback=function(){_xhrCall(checkoutParams.urls.saveShippingMethod,_serializeForm(config.shippingMethodFormId),callbacks.onXhrSuccess,callbacks.onXhrError,function(){_setLoadWaiting(checkoutParams.review)},function(){_unsetLoadWaiting(checkoutParams.review)})},_authorizationCallback=function(e){e?config.popup?amazon.Login.authorize({scope:config.scope,popup:config.popup},function(e){return e.error?void alert(e.error):void(e.access_token&&_xhrCall(config.addToCartUrl,_serializeForm(config.addToCartFormId),function(r){return r=JSON.parse(r),r.error?void _handleXhrErrorResponse(r):void(r.success&&(window.location.href=config.pay.callbackUrl+"?access_token="+e.access_token))},callbacks.onXhrError,_showOverlay,_hideOverlay))}):_xhrCall(config.addToCartUrl,_serializeForm(config.addToCartFormId),function(e){return e=JSON.parse(e),e.error?void _handleXhrErrorResponse(e):void(e.success&&amazon.Login.authorize({scope:config.scope,popup:config.popup},config.pay.callbackUrl))},callbacks.onXhrError,_showOverlay,_hideOverlay):amazon.Login.authorize({scope:config.scope,popup:config.popup},config.pay.callbackUrl)},_signInCallback=function(e){var r=document.createElement("input");r.setAttribute("type","hidden"),r.setAttribute("name","orderReferenceId"),r.setAttribute("value",e.getAmazonOrderReferenceId());var o=document.createElement("form");o.setAttribute("method","post"),o.setAttribute("action",config.checkoutUrl),o.appendChild(r),document.body.appendChild(o),o.submit()},_widgetErrorCallback=function(e){config.debug&&alert("["+e.getErrorCode()+"]: "+e.getErrorMessage()),errorCodes.clearOrderReference.some(function(r){return r===e.getErrorCode()})&&(window.location.href=checkoutParams.urls.clearOrderReference||checkoutParams.urls.failure),errorCodes.cancelOrderReference.some(function(r){return r===e.getErrorCode()})&&(window.location.href=checkoutParams.urls.cancelOrderReference||checkoutParams.urls.failure),errorCodes.redirect.some(function(r){return r===e.getErrorCode()})&&(window.location.href=checkoutParams.urls.failure)},_xhrErrorCallback=function(e){config.debug&&alert(e.statusText),e.getResponseHeader("Login-Required")&&checkoutParams.urls.failure&&(window.location.href=checkoutParams.urls.failure)},_xhrSuccessCallback=function(e){_handleXhrResponse(e)},callbacks={authorization:_authorizationCallback,onAddressSelect:_addressSelectCallback,onPayButtonRender:null,onButtonError:_widgetErrorCallback,onOrderReferenceCreate:_orderReferenceCreateCallback,onPaymentSelect:_paymentSelectCallback,onShippingMethodSelect:_shippingMethodSelectCallback,onSignIn:_signInCallback,onWidgetError:_widgetErrorCallback,onXhrError:_xhrErrorCallback,onXhrSuccess:_xhrSuccessCallback},_emptyCallback=function(){},_setCheckoutSubmitAllowed=function(e){checkoutSubmitAllowed=e,_updateCheckoutSubmitButtonState()},_setCheckoutPaymentSelected=function(e){checkoutPaymentSelected=e,_updateCheckoutSubmitButtonState()},_updateCheckoutSubmitButtonState=function(){var e=document.getElementById(config.checkoutSubmitButtonId);e&&(e.disabled=!checkoutSubmitAllowed||!checkoutPaymentSelected)},_handleXhrResponse=function(e){e=JSON.parse(e),e.error&&_handleXhrErrorResponse(e),e.redirect&&(window.location.href=e.redirect),e.render_widget&&(e.render_widget.wallet&&_renderWalletWidget(),e.render_widget["shipping-method"]&&_renderShippingMethod(e.render_widget["shipping-method"]),e.render_widget.review&&_renderReview(e.render_widget.review)),e.disable_widget&&e.disable_widget["address-book"]&&_renderAddressBookWidget("Read"),_setCheckoutSubmitAllowed(e.allow_submit),e.deselect_payment&&_setCheckoutPaymentSelected(!1)},_handleXhrErrorResponse=function(e){e.error_messages&&("object"!=typeof e.error_messages?alert(e.error_messages):alert(e.error_messages.join("\n")))},_getDisplayMode=function(e){return e?e:"Edit"},_renderAddressBookWidget=function(e){return e=_getDisplayMode(e),addressBookWidget=new OffAmazonPayments.Widgets.AddressBook({sellerId:config.merchantId,displayMode:e,onOrderReferenceCreate:"Edit"===e?callbacks.onOrderReferenceCreate:_emptyCallback,amazonOrderReferenceId:checkoutOrderReferenceId,design:checkoutParams.responsive?{designMode:"responsive"}:checkoutParams.addressBook,onAddressSelect:"Edit"===e?callbacks.onAddressSelect:_emptyCallback,onError:callbacks.onWidgetError}),addressBookWidget.bind(checkoutParams.addressBook),this},_renderWalletWidget=function(){var e={sellerId:config.merchantId,onOrderReferenceCreate:callbacks.onOrderReferenceCreate,amazonOrderReferenceId:checkoutOrderReferenceId,design:checkoutParams.responsive?{designMode:"responsive"}:checkoutParams.wallet,onPaymentSelect:callbacks.onPaymentSelect,onError:callbacks.onWidgetError};return config.currency&&(e.presentmentCurrency=config.currency),walletWidget=new OffAmazonPayments.Widgets.Wallet(e),walletWidget.bind(checkoutParams.wallet),this},_renderShippingMethod=function(e){var r=_getElementById(checkoutParams.shippingMethod);if(r){if(r.onchange=callbacks.onShippingMethodSelect,r.innerHTML=e,_evalJsScripts(r),!r.down("input[type=radio]:checked")){var o=r.down("input[type=radio]");o&&(o.checked=!0)}callbacks.onShippingMethodSelect()}return this},_renderReview=function(e){var r=_getElementById(checkoutParams.review);return r&&(r.innerHTML=e,_evalJsScripts(r)),this},saveOrder=function(){_setCheckoutSubmitAllowed(!1),_xhrCall(checkoutParams.urls.saveOrder,_serializeForm(config.checkoutAgreementsFormId,config.shippingMethodFormId,config.simulationFormId),callbacks.onXhrSuccess,callbacks.onXhrError,_setFormLoadWaiting,_unsetFormLoadWaiting)},submitCoupon=function(e){_setCheckoutSubmitAllowed(!1),_xhrCall(checkoutParams.urls.saveCoupon,e?_serializeForm(config.discountCouponFormId)+"&remove=1":_serializeForm(config.discountCouponFormId),callbacks.onXhrSuccess,callbacks.onXhrError,function(){_showOverlay(),_setLoadWaiting(checkoutParams.review)},function(){_hideOverlay(),_unsetLoadWaiting(checkoutParams.review)})},initCheckout=function(e){_extendObj(checkoutParams,e),_setCheckoutSubmitAllowed(!1),config.virtual?(_renderWalletWidget(),_setCheckoutSubmitAllowed(!0)):(_renderAddressBookWidget(),checkoutOrderReferenceId&&_renderWalletWidget())},logout=function(){amazon.Login.logout(),Mage.Cookies.clear("amazon_Login_accessToken")},initLogin=function(){return amazon.Login.setClientId(config.clientId),amazon.Login.setUseCookie(!0),this},renderButtons=function(){var e=null;if(config.pay.selector){var r=_getElementsBySelector(config.pay.selector);if(config.pay&&config.pay.callbackUrl)for(var o=0;o<r.length;o++)e=r[o],e&&new OffAmazonPayments.Button(e.id,config.merchantId,{type:e.dataset.buttonType||config.pay.design&&config.pay.design.type||"PwA",size:e.dataset.buttonSize||config.pay.design&&config.pay.design.size||"small",color:e.dataset.buttonColor||config.pay.design&&config.pay.design.color||"Gold",language:config.language,onError:callbacks.onButtonError,authorization:function(){callbacks.authorization(e.dataset.isProductButton)}}),callbacks.onPayButtonRender&&callbacks.onPayButtonRender(e);else for(var o=0;o<r.length;o++)e=r[o],e&&new OffAmazonPayments.Widgets.Button({sellerId:config.merchantId,useAmazonAddressBook:!config.virtual,onSignIn:callbacks.onSignIn,onError:callbacks.onButtonError}).bind(e.id),callbacks.onPayButtonRender&&callbacks.onPayButtonRender(e)}if(config.login&&config.login.selector)for(var t=_getElementsBySelector(config.login.selector),o=0;o<t.length;o++)e=t[o],e&&new OffAmazonPayments.Button(e.id,config.merchantId,{type:e.dataset.buttonType||config.login.design&&config.login.design.type||"LwA",size:e.dataset.buttonSize||config.login.design&&config.login.design.size||"small",color:e.dataset.buttonColor||config.login.design&&config.login.design.color||"Gold",language:config.language,onError:callbacks.onButtonError,authorization:function(){amazon.Login.authorize({scope:config.scope,popup:config.popup},config.login.callbackUrl)}});return this},setOrderReferenceId=function(e){return checkoutOrderReferenceId=e,this},setCallbacks=function(e){return _extendObj(callbacks,e),this},setup=function(e){return _extendObj(config,e),this};return{setup:setup,setCallbacks:setCallbacks,setOrderReferenceId:setOrderReferenceId,renderButtons:renderButtons,initLogin:initLogin,logout:logout,initCheckout:initCheckout,submitCoupon:submitCoupon,saveOrder:saveOrder}}($$,Form.serialize);